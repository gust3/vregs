<?php// Запрет прямого доступа.defined('_JEXEC') or die; // Подключаем библиотеку modellist Joomla.jimport('joomla.application.component.modeladmin'); class gustVMtoolsModelGotadresses extends JModelAdmin{    /**     * Метод для построения SQL запроса для загрузки списка данных.     *     * @return string SQL запрос.     */	public function getForm($data = array(), $loadData = true) 	{	}	    public function got()	{		$db	=& JFactory::getDBO();		$query = "SELECT ymname, id FROM #__vmtools_netshop";		$db->setQuery($query);		$nets = $db->loadObjectList();				$query = "SELECT maps, region FROM products_maps";		$db->setQuery($query);		$maps = $db->loadObjectList();				$i = 0;		/*		foreach ($maps as $item)		{			$array_adresses = explode(';', $item->maps);			foreach ($array_adresses as $adress)			{				$adress_details = explode(':', $adress);				if (!$adress_details[1]) continue;				if (!$adress_details[2]) continue;				foreach ($nets as $net)				{					if (str_replace("'","",$net->ymname) == $adress_details[0]){						$id_net = $net->id;						break;					}				}								$adresses[$i][] = $adress_details[1];				$adresses[$i][] = $item->region;				$adresses[$i][] = $id_net;				$i++;																				$form['adress'] = $adress_details[1];				$form['id_region'] = $item->region;				$form['id_net'] = $id_net;				$form['published'] = 1;				$form['x'] = ' ';				$form['y'] = ' ';				$form['url'] = ' ';				$form['clocks'] = ' ';				$form['vidacha_zakazov']= ' ';				$form['oplata'] = ' ';				$form['label'] = ' ';				$form['email'] = " ";				$form['phones'] = " ";				$row =& JTable::getInstance('netadress', 'Table');				$row->bind($form);				$row->check($form);				$row->store($form, true);							}		}				foreach ($adresses as $item)		{			if ($got_adresses)			{				$y = 0;				foreach ($got_adresses as $g_a)				{					if ($item[0] == $g_a) 					{						$y=1;						break;					}				}						}			if ($y == 1) continue;						$form['adress'] = $item[0];			$form['id_region'] = $item[1];			$form['id_net'] = $item[2];			$form['published'] = 1;			$form['x'] = ' ';			$form['y'] = ' ';			$form['url'] = ' ';			$form['clocks'] = ' ';			$form['vidacha_zakazov']= ' ';			$form['oplata'] = ' ';			$form['label'] = ' ';			$form['email'] = " ";			$form['phones'] = " ";			$row =& JTable::getInstance('netadress', 'Table');			$row->bind($form);			$row->check($form);			$row->store($form, true);			$got_adresses[] = $item[0];		}		*/		$i=0;		$query = "SELECT sctx, id_region FROM #__vmtools_regions";		$db->setQuery($query);		$regions = $db->loadObjectList();								foreach($nets as $item){			$i++;			foreach($regions as $region)			{						$url = 'http://maps.yandex.ru/?text='.$item->ymname.'&z=10&results=50&sctx='.$region->sctx.'&source=mouse&output=json';			$ch = curl_init ();			curl_setopt ($ch , CURLOPT_URL , $url);			curl_setopt ($ch , CURLOPT_USERAGENT , "Mozilla/5.0"); 			curl_setopt ($ch , CURLOPT_RETURNTRANSFER , 1 );			curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 1);			curl_setopt ($ch, CURLOPT_COOKIE, "yandex_gid=".$region->id_region);  			curl_setopt ($ch , CURLOPT_RETURNTRANSFER , 1 ); // нам нужно вывести загруженную страницу в переменную			$content = curl_exec($ch); // скачиваем страницу			$header  = curl_getinfo($ch);			$err     = curl_errno( $ch );			$errmsg  = curl_error( $ch );			curl_close($ch); // закрываем соединение			$cart = json_decode( $content, true );			for ($j=0;$j<count($cart['vpage']['data']['businesses']['GeoObjectCollection']['features']);$j++)			{				unset($form);				unset($phones);				$form['x'] = $cart['vpage']['data']['businesses']['GeoObjectCollection']['features'][$j]['geometry']['coordinates'][0];				$form['y'] = $cart['vpage']['data']['businesses']['GeoObjectCollection']['features'][$j]['geometry']['coordinates'][0];				$form['adress'] = $cart['vpage']['data']['businesses']['GeoObjectCollection']['features'][$j]['properties']['CompanyMetaData']['address'];				$form['url'] = $cart['vpage']['data']['businesses']['GeoObjectCollection']['features'][$j]['properties']['CompanyMetaData']['url'];				$form['clocks'] = $cart['vpage']['data']['businesses']['GeoObjectCollection']['features'][$j]['properties']['CompanyMetaData']['Hours']['text'];				$form['vidacha_zakazov'] = $cart['vpage']['data']['businesses']['GeoObjectCollection']['features'][$j]['properties']['CompanyMetaData']['Features'][0]['value'];				$form['dostavka'] = $cart['vpage']['data']['businesses']['GeoObjectCollection']['features'][$j]['properties']['CompanyMetaData']['Features'][1]['value'];								if (count($cart['vpage']['data']['businesses']['GeoObjectCollection']['features'][$j]['properties']['CompanyMetaData']['Features'][2]['values'])>0){					$form['oplata'] = implode(';', $cart['vpage']['data']['businesses']['GeoObjectCollection']['features'][$j]['properties']['CompanyMetaData']['Features'][2]['values']);				}				$form['label'] = $cart['vpage']['data']['businesses']['GeoObjectCollection']['features'][$j]['properties']['CompanyMetaData']['internal']['synonym'];				$form['email'] = $cart['vpage']['data']['businesses']['GeoObjectCollection']['features'][$j]['properties']['CompanyMetaData']['internal']['email'];								if (count($cart['vpage']['data']['businesses']['GeoObjectCollection']['features'][$j]['properties']['CompanyMetaData']['Phones'])>0)				{					foreach ($cart['vpage']['data']['businesses']['GeoObjectCollection']['features'][$j]['properties']['CompanyMetaData']['Phones'] as $item2)					{						$phones[] = $item2['formatted'];								}					if (count($phones)>0){						$form['phones'] = implode(';', $phones);					}							}				$form['id_region'] = $region->id_region;				$form['id_net'] = $item->id;				$form['published'] = 1;								$row =& JTable::getInstance('netadress', 'Table');				$row->bind($form);				$row->check($form);				$row->store($form, true);			}					unset($content);		}		}	}}